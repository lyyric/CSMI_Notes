### 计算 $x^n$

#### 背景假设
$x$ 属于一个乘法群，比如 $\mathbb{Z}^*$、$(\mathbb{Z}/n\mathbb{Z})^*$ 或矩阵群 $M_d(\mathbb{Z})$。我们关注的核心问题是 **用尽量少的乘法计算 $x^n$**。

**注意**：我们暂时忽略数据大小对算法的影响，只计算乘法的次数。

---

### 方法 1：朴素算法

#### 思路
反复乘 $x$：
1. 初始化 $y = x$
2. 执行 $n-1$ 次乘法操作，将 $y = y \cdot x$
3. 最终 $y = x^n$

#### 伪代码
```python
输入 x, n
y = x
对于 i 从 1 到 n-1:
    y = y * x
输出 y
```

#### 成本
需要 **$n-1$ 次乘法**。

---

### 方法 2：二进制快速幂算法

#### 思路
把 $n$ 写成二进制形式：
$$
n = \varepsilon_0 + \varepsilon_1 2^1 + \varepsilon_2 2^2 + \cdots + \varepsilon_k 2^k
$$
其中 $\varepsilon_i \in \{0, 1\}$，表示 $n$ 的第 $i$ 位。  
例如，$13 = 1101_2 = 2^3 + 2^2 + 2^0$。

我们可以按以下步骤计算：
1. 从 $x^1$ 开始，逐次平方：计算 $x^2, x^4, x^8, \dots$
2. 根据 $n$ 的二进制表示，将需要的幂次乘起来。例如 $13 = 2^3 + 2^2 + 2^0$，所以需要 $x^8 \cdot x^4 \cdot x$。

#### 优化点
只需要计算每一位的平方（$k = \lfloor \log_2 n \rfloor$ 次平方），以及二进制中为 1 的位所需的额外乘法。

---

#### 伪代码
```python
输入 x, n
y = 1
当 n > 0:
    如果 n 是奇数:
        y = y * x
    x = x * x
    n = n // 2
输出 y
```

#### 例子
计算 $x^{13}$:
1. $13 = 1101_2$，对应幂次为 $1, 4, 8$。
2. 需要计算 $x^1, x^2, x^4, x^8$。
3. 乘法次数：3 次平方 + 2 次乘积，总共 5 次。

---

### 改进与理论分析

#### 能否进一步减少乘法？
快速幂算法已经非常高效，但如果允许我们灵活组合中间结果，还可以设计更优的算法。

例如，计算 $x^{15}$，二进制方法需要 6 次乘法（$x, x^2, x^4, x^8$ 的平方和组合）。但通过以下步骤，我们只需 5 次乘法：
1. 计算 $x^2$（第 1 次乘法）
2. 计算 $x^3 = x^2 \cdot x$（第 2 次乘法）
3. 计算 $x^6 = x^3 \cdot x^3$（第 3 次乘法）
4. 计算 $x^{12} = x^6 \cdot x^6$（第 4 次乘法）
5. 计算 $x^{15} = x^{12} \cdot x^3$（第 5 次乘法）

#### 加法链的概念
要计算 $x^n$，我们可以构造一个 **加法链**，通过最少的乘法获得所有中间幂次。

##### 定义
加法链是一个整数序列：
$$
A_0 = 1, \, A_1, \, \dots, \, A_r = n,
$$
其中每个 $A_i$ 可以表示为前面某两个数的和：
$$
A_i = A_j + A_k \quad (0 \leq j, k < i)。
$$

##### 目标
寻找长度最短的加法链。记 $\ell(n)$ 为 $n$ 的最短加法链的长度。

---

### 关键理论

#### 上下界
对于任意 $n$：
$$
\log_2 n \leq \ell(n) \leq 2 \lfloor \log_2 n \rfloor。
$$

#### 极限
$$
\lim_{n \to \infty} \frac{\ell(n)}{\log_2 n} = 1。
$$

也就是说，当 $n$ 非常大时，加法链的最优长度趋近于 $\log_2 n$，说明快速幂算法已经接近最优。

---

### 更进一步的优化：自适应基数

#### 思路
上面用的是固定的二进制（基数 $2$）。如果我们允许动态调整基数，计算效率可以进一步提升。

假设我们选择基数 $m = 2^k$。把 $n$ 写成 $m$ 进制：
$$
n = d_0 + d_1 m + d_2 m^2 + \cdots + d_t m^t,
$$
其中 $d_i \in \{0, 1, \dots, m-1\}$。

#### 优化分析
- 我们需要 $k$ 次乘法来计算 $x^m, x^{m^2}, \dots$；
- 对每个 $d_i$ 需要额外的加法和乘法。

通过选择一个合适的 $k$，可以平衡平方和乘法的次数，进一步优化。

#### 总结公式
对于一个足够大的 $n$，可以证明：
$$
\ell(n) \leq \log_2 n + C \frac{\log_2 n}{\log_2 \log_2 n},
$$
其中 $C$ 是一个常数（大约等于 10）。

这表明，即使进一步优化，乘法次数也不会低于 $\log_2 n$ 的倍数。