#include <stdio.h>
#include <stdarg.h>
#include <stdnoreturn.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>

#define CHK(op) do { if ((op) == -1) raler(1, #op); } while (0)

#define BUFFER_SIZE 8192

noreturn void raler(int syserr, const char *msg, ...) {
    va_list ap;
    va_start(ap, msg);
    vfprintf(stderr, msg, ap);
    fprintf(stderr, "\n");
    va_end(ap);

    if (syserr) {
        perror("");
    }

    exit(EXIT_FAILURE);
}

int main(int argc, char** argv){
    if (argc != 2)
        raler(0,"usage: executable rep\n");

    int fd,rasion;

    switch (fork())
    {
    case -1:
        raler(1,"echec fork()");
        break;
    
    case 0:
        CHK(fd = open("/dev/null",O_WRONLY));
        CHK(dup2(fd,1));
        CHK(close(fd));
        execlp("ls","ls","-R",argv[1],NULL);
        raler(1,"echec exec");
        break;

    default:
        CHK(wait(&rasion));
        if(!(WIFEXITED(rasion)) || (WEXITSTATUS(rasion)!=0))
            raler(0,"terminaison processus fils");
        break;
    }
    return 0;
}