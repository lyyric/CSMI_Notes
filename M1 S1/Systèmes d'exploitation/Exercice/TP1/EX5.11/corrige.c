#include <stdio.h>
#include <stdarg.h>
#include <stdnoreturn.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <dirent.h>
#include <sys/stat.h>
#include <string.h>
#include <errno.h>

#define SIZE 1024

// Macro to check system calls for errors
#define CHK(op) do { if ((op) == -1) raler(1, #op); } while (0)
#define CHKN(op) do { if ((op) == NULL) raler(1, #op); } while (0)

// Error reporting function
noreturn void raler(int syserr, const char *msg, ...) {
    va_list ap;
    va_start(ap, msg);
    vfprintf(stderr, msg, ap);
    fprintf(stderr, "\n");
    va_end(ap);

    if (syserr) {
        perror("");
    }

    exit(EXIT_FAILURE);
}

// Function to copy a file from path1 to path2
void recopier (char *path1, char *path2) {
    int fd1, fd2;
    CHK(fd1 = open(path1, O_RDONLY));  // Open source file for reading
    CHK(fd2 = open(path2, O_WRONLY | O_CREAT | O_TRUNC, 0666));  // Open destination file for writing

    int nbl;
    char buf[SIZE];
    while ((nbl = read(fd1, buf, SIZE)) > 0) {
        CHK(write(fd2, buf, nbl));  // Write to destination
    }

    CHK(nbl);  // Check for read errors
    CHK(close(fd1));  // Close source file
    CHK(close(fd2));  // Close destination file
}

// Function to recursively list and copy directories and files
void lister (char *path1, char *path2) {
    DIR *dir;
    CHKN(dir = opendir(path1));  // Open the source directory
    CHK(mkdir(path2, 0777));    // Create destination directory with appropriate permissions

    struct dirent *dp;

    while ((dp = readdir(dir)) != NULL) {
        if (dp->d_name[0] == '.')  // Ignore hidden files
            continue;

        char destination1[SIZE];
        char destination2[SIZE];
        int s = snprintf(destination1, SIZE, "%s/%s", path1, dp->d_name);
        if (s < 0 || s >= SIZE)
            raler(0, "snprintf");

        s = snprintf(destination2, SIZE, "%s/%s", path2, dp->d_name);
        if (s < 0 || s >= SIZE)
            raler(0, "snprintf");

        struct stat sbuf;
        CHK(stat(destination1, &sbuf));  // Get file status

        if (S_ISDIR(sbuf.st_mode)) {
            lister(destination1, destination2);  // Recursively list the directory
        } else if (S_ISREG(sbuf.st_mode)) {
            recopier(destination1, destination2);  // Copy regular files
        } else {
            raler(0, "element non reconnu");  // Handle unknown file types
        }
    }

    errno = 0;
    if (errno != 0)
        raler(1, "readdir");

    closedir(dir);  // Close the directory
}

// Main function to check arguments and initiate the directory copy process
int main(int argc, char *argv[]) {
    if (argc != 3) {
        raler(0, "Usage: %s <source_directory> <destination_directory>", argv[0]);
    }

    // Call the lister function to copy from source to destination
    lister(argv[1], argv[2]);

    return 0;
}
