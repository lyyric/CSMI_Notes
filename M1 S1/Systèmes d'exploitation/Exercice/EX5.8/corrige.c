#include <stdio.h>
#include <stdarg.h>
#include <stdnoreturn.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>

#define CHK(op) do { if ((op) == -1) raler(1, #op); } while (0)

noreturn void raler(int syserr, const char *msg, ...) {
    va_list ap;
    va_start(ap, msg);
    vfprintf(stderr, msg, ap);
    fprintf(stderr, "\n");
    va_end(ap);

    if (syserr) {
        perror("");
    }

    exit(EXIT_FAILURE);
}

char get_type (mode_t type){
    if (S_ISDIR(type))
        return 'd';
    else if (S_ISREG(type))
        return '-';
    else
        raler(0, "type inconnu");
}

void get_permission (mode_t type, char *droits){
    int masque = 0400;

    for (int i = 0; i < 9; i++) {
        if ((type & masque) == 0)
            droits[i] = '-';
        masque = masque / 2;
    }
}

int main(int argc, char *argv[]) {
    if (argc != 2)
        raler(0, "usage: %s fichier", argv[0]);

    struct stat sbuf;
    CHK(stat(argv[1], &sbuf));
    char ch;
    ch = get_type(sbuf.st_mode);
    printf("%c\n", ch);
    char droits[] = "rwxrwxrwx";
    get_permission(sbuf.st_mode, droits);
    printf("%c%s\n", ch, droits);
    return 0;
}

